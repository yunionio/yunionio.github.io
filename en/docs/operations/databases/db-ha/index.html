<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-operations/databases/db-ha" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Deploy Mariadb HA | Cloudpods</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://www.cloudpods.org/en/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://www.cloudpods.org/en/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://www.cloudpods.org/en/docs/operations/databases/db-ha"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" property="og:locale:alternate" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Deploy Mariadb HA | Cloudpods"><meta data-rh="true" name="description" content="Use keepalived and Mariadb&#x27;s master-master replication feature to achieve high availability of DB."><meta data-rh="true" property="og:description" content="Use keepalived and Mariadb&#x27;s master-master replication feature to achieve high availability of DB."><link data-rh="true" rel="icon" href="/en/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.cloudpods.org/en/docs/operations/databases/db-ha"><link data-rh="true" rel="alternate" href="https://www.cloudpods.org/docs/operations/databases/db-ha" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://www.cloudpods.org/en/docs/operations/databases/db-ha" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.cloudpods.org/docs/operations/databases/db-ha" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Cloudpods RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Cloudpods Atom Feed">



<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-999X9XX9XX"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-999X9XX9XX",{anonymize_ip:!0})</script>

<script src="https://hm.baidu.com/hm.js?3c5253cd6530122d0f774cab69e3c07f" async></script>
<script src="/js/github-star.js" async></script><link rel="stylesheet" href="/en/assets/css/styles.bf8d0121.css">
<script src="/en/assets/js/runtime~main.c8aa0ee0.js" defer="defer"></script>
<script src="/en/assets/js/main.684ddf92.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/cloudpods_circle_black.svg" alt="Cloudpods Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/en/img/cloudpods_circle_white.svg" alt="Cloudpods Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Cloudpods</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/introduction/">Docs</a><a class="navbar__item navbar__link" href="/en/blog">Blog</a><a href="https://www.yunion.cn/subscription/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Subscription</a><a href="https://apifox.com/apidoc/shared-f917f6a6-db9f-4d6a-bbc3-ea58c945d7fd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/en/docs/introduction/">3.11</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/en/docs/operations/databases/db-ha">3.11</a></li><li><a href="https://www.cloudpods.org/v3.10/" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.10<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://v1.cloudpods.org/v3.9/" target="_blank" rel="noopener noreferrer" class="dropdown__link">3.9<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/en/docs/operations/databases/db-ha"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/operations/databases/db-ha" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-Hans">简体中文</a></li><li><a href="/en/docs/operations/databases/db-ha" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><a href="https://github.com/yunionio/cloudpods" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link GitHubLink-custom">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/en/docs/introduction/">Introduction</a><button aria-label="Expand sidebar category &#x27;Introduction&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/en/docs/getting-started/">Getting Started</a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/en/docs/guides/">User Guides</a><button aria-label="Expand sidebar category &#x27;User Guides&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/en/docs/operations/">Operations</a><button aria-label="Collapse sidebar category &#x27;Operations&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/component">Component Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/en/docs/operations/upgrading/">Upgrade</a><button aria-label="Expand sidebar category &#x27;Upgrade&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/en/docs/operations/k8s/">Kubernetes运维</a><button aria-label="Expand sidebar category &#x27;Kubernetes运维&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/en/docs/operations/databases/">Databases</a><button aria-label="Collapse sidebar category &#x27;Databases&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/databases/mysql_config">MariaDB Recommended Configurations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/operations/databases/db-ha">Deploy Mariadb HA</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/databases/mysql_ha_recovery">MariaDB 双主同步恢复</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/en/docs/operations/ha/">高可用环境</a><button aria-label="Expand sidebar category &#x27;高可用环境&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/en/docs/operations/fe/">前端组件运维</a><button aria-label="Expand sidebar category &#x27;前端组件运维&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/en/docs/operations/log/">日志运维</a><button aria-label="Expand sidebar category &#x27;日志运维&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/en/docs/operations/monitoring/">监控运维</a><button aria-label="Expand sidebar category &#x27;监控运维&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/en/docs/operations/platform-issues/">平台常见问题</a><button aria-label="Expand sidebar category &#x27;平台常见问题&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/hidden-feature-config">Hidden Feature Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/multi-zone-config">Multi-Availability Zone Service Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/remove-host">Offline Private Cloud Computing Nodes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/clean-kvm-security-groups">清理未使用的安全组</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/change-node-ip">Changing Node IP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/uninstallation">Uninstall</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/operations/agent">手动安装监控Agent</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/en/docs/development/">Development</a><button aria-label="Expand sidebar category &#x27;Development&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/en/docs/release-notes/">Release Notes</a><button aria-label="Expand sidebar category &#x27;Release Notes&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/en/docs/contact/">Contact US</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/operations/"><span itemprop="name">Operations</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/en/docs/operations/databases/"><span itemprop="name">Databases</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Deploy Mariadb HA</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Deploy Mariadb HA</h1>
<p>Use keepalived and Mariadb&#x27;s master-master replication feature to achieve high availability of DB.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment" href="/en/docs/operations/databases/db-ha#deployment">​</a></h2>
<p>The main function of keepalived is to provide vip for Mariadb, switching between 2 Mariadb instances to provide uninterrupted service.</p>
<p>In the following example:</p>
<ul>
<li>DB VIP: 192.168.199.97</li>
<li>Primary node IP: 192.168.199.98</li>
<li>Backup node IP: 192.168.199.99</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-mariadb-master-master-replication">Configure Mariadb master-master replication<a class="hash-link" aria-label="Direct link to Configure Mariadb master-master replication" title="Direct link to Configure Mariadb master-master replication" href="/en/docs/operations/databases/db-ha#configure-mariadb-master-master-replication">​</a></h3>
<p>Install and start Mariadb</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ yum </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> mariadb-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> mariadb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run the Mariadb Security Configuration Wizard to set passwords, etc.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ mysql_secure_installation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Change the root password? </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">New password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Re-enter new password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password updated successfully</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reloading privilege tables</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remove anonymous users? </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disallow root login remotely? </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remove </span><span class="token builtin class-name">test</span><span class="token plain"> database and access to it? </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Dropping </span><span class="token builtin class-name">test</span><span class="token plain"> database</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Removing privileges on </span><span class="token builtin class-name">test</span><span class="token plain"> database</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reload privilege tables now? </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Y/n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Modify the Mariadb configuration file to prepare for configuring the master-master replication.</p>
<p>Note: The difference between primary and secondary is the <code>confserver-id</code> and <code>auto_increment_offset</code> fields.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Primary node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /etc/my.cnf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[mysqld]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">datadir=/var/lib/mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">socket=/var/lib/mysql/mysql.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">symbolic-links=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># Settings user and group are ignored when systemd is used.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># If you need to run mysqld under a different user or group,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># customize your systemd unit file for mariadb according to the</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># instructions in http://fedoraproject.org/wiki/Systemd</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># skip domain name resolve</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">skip_name_resolve</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># auto delete binlog older than 30 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">expire_logs_days=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">innodb_file_per_table=ON</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_connections = 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_allowed_packet=20M</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">server-id = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">auto_increment_offset = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">auto_increment_increment = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">log-bin = mysql-bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">binlog-format = row</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">log-slave-updates</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_binlog_size = 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">replicate-ignore-db = information_schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">replicate-ignore-db = performance_schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_connections = 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_connect_errors = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_allowed_packet = 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">slave-net-timeout=10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">master-retry-count=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">slow_query_log = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">long_query_time = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">slow_query_log_file = /var/log/mariadb/slow-query.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[mysql]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">no-auto-rehash</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[mysqld_safe]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">log-error=/var/log/mariadb/mariadb.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">pid-file=/var/run/mariadb/mariadb.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># include all files from the config directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">!includedir /etc/my.cnf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Backup Node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /etc/my.cnf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[mysqld]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">datadir=/var/lib/mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">socket=/var/lib/mysql/mysql.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">symbolic-links=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># Settings user and group are ignored when systemd is used.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># If you need to run mysqld under a different user or group,</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># customize your systemd unit file for mariadb according to the</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># instructions in http://fedoraproject.org/wiki/Systemd</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># skip domain name resolve</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">skip_name_resolve</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># auto delete binlog older than 30 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">expire_logs_days=30</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">innodb_file_per_table=ON</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_connections = 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_allowed_packet=20M</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">server-id = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">auto_increment_offset = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">auto_increment_increment = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">log-bin = mysql-bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">binlog-format = row</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">log-slave-updates</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_binlog_size = 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">replicate-ignore-db = information_schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">replicate-ignore-db = performance_schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_connections = 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_connect_errors = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">max_allowed_packet = 1G</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">slave-net-timeout=10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">master-retry-count=0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">slow_query_log = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">long_query_time = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">slow_query_log_file = /var/log/mariadb/slow-query.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[mysql]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">no-auto-rehash</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[mysqld_safe]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">log-error=/var/log/mariadb/mariadb.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">pid-file=/var/run/mariadb/mariadb.pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># include all files from the config directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">!includedir /etc/my.cnf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Restart the service</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl restart mariadb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On the primary node, create a read-only account, export all data, and import it into the backup node. Record the name and position of the binlog log file.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># The following commands are executed on the primary node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This password is for the Mariadb root set above. For convenience, the read-only account also uses this password</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_PASSWD</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;your-sql-passwd&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Enable remote access to Mariadb</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mysql </span><span class="token parameter variable" style="color:#36acaa">-uroot</span><span class="token plain"> -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;</span><span class="token string variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token string" style="color:#e3116c">&#x27; WITH GRANT OPTION;FLUSH PRIVILEGES&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create a read-only account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GRANT REPLICATION SLAVE ON *.* TO repl@&#x27;%&#x27; IDENTIFIED BY &#x27;</span><span class="token string variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token string" style="color:#e3116c">&#x27;;FLUSH PRIVILEGES&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This example is for a fresh installation of Mariadb that hasn&#x27;t been used yet. If you&#x27;re doing master-master replication of a database that&#x27;s already in use, you need to lock the table before exporting data. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">``````bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mysql </span><span class="token parameter variable" style="color:#36acaa">-uroot</span><span class="token plain"> -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SHOW PROCESSLIST&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+------+-----------+------+---------+------+-------+------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Id </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> User </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Host      </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> db   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Command </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Time </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> State </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Info             </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Progress </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+------+-----------+------+---------+------+-------+------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> root </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> localhost </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> NULL </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Query   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> NULL  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> SHOW PROCESSLIST </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0.000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+------+-----------+------+---------+------+-------+------------------+----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Record the binlog file name and position</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SHOW MASTER STATUS\G&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*************************** </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">. row ***************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            File: mysql-bin.000001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Position: </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Binlog_Do_DB:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Binlog_Ignore_DB:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Export all data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mysqldump --all-databases -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> alldb.db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Copy alldb.db to the backup node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> alldb.db db2:/root/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Execute the following commands on the backup node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This password is the MariaDB root password set above</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token assign-left variable" style="color:#36acaa">MYSQL_PASSWD</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;your-sql-passwd&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Import the data exported from the primary node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> alldb.db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Reload privileges</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;FLUSH PRIVILEGES&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Record the binlog file name and position</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SHOW MASTER STATUS\G&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*************************** </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">. row ***************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            File: mysql-bin.000001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Position: </span><span class="token number" style="color:#36acaa">509778</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Binlog_Do_DB:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Binlog_Ignore_DB:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Set up master-slave replication</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Execute the following commands on the primary node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Modify MASTER_HOST to the IP address of the backup node, and modify MASTER_LOG_FILE and MASTER_LOG_POS based on the information recorded on the backup node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CHANGE MASTER TO MASTER_HOST=&#x27;192.168.199.99&#x27;,MASTER_USER=&#x27;repl&#x27;,MASTER_PASSWORD=&#x27;</span><span class="token string variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token string" style="color:#e3116c">&#x27;,MASTER_PORT=3306,MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,MASTER_LOG_POS=509778,MASTER_CONNECT_RETRY=2;START SLAVE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Execute the following commands on the backup node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Modify MASTER_HOST to the IP address of the primary node, and modify MASTER_LOG_FILE and MASTER_LOG_POS based on the information recorded on the primary node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CHANGE MASTER TO MASTER_HOST=&#x27;192.168.199.98&#x27;,MASTER_USER=&#x27;repl&#x27;,MASTER_PASSWORD=&#x27;</span><span class="token string variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token string" style="color:#e3116c">&#x27;,MASTER_PORT=3306,MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,MASTER_LOG_POS=2023,MASTER_CONNECT_RETRY=2;START SLAVE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Execute this command on both primary and backup nodes, verify synchronization status, and output 2 Yes to indicate normal status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mysql </span><span class="token parameter variable" style="color:#36acaa">-u</span><span class="token plain"> root -p</span><span class="token variable" style="color:#36acaa">$MYSQL_PASSWD</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SHOW SLAVE STATUS\G&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Slave_IO_Running: Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Slave_SQL_Running: Yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If this step fails, for example, if Slave_SQL_Running is connecting, it&#x27;s highly likely that the firewall has not been turned off. Please execute the following command to turn off the firewall, and then redo the previous step of checking the two Yes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl is-active firewalld </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/dev/null </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> systemctl disable </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> firewalld</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The DB master-master replication deployment is now complete. You can test database operations on any node and verify them on the other node. However, it is still necessary to provide services externally through the VIP, otherwise if a switch occurs, the business side will need to switch IPs. Next, configure keepalived to provide external services.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-and-configure-keepalived">Deploy and configure keepalived<a class="hash-link" aria-label="Direct link to Deploy and configure keepalived" title="Direct link to Deploy and configure keepalived" href="/en/docs/operations/databases/db-ha#deploy-and-configure-keepalived">​</a></h3>
<p>Set the relevant environment variables and configure them according to different environments.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># keepalived vip address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">DB_VIP</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.199.97</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># keepalived auth toke</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">DBHA_KA_AUTH</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">onecloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># keepalived network interface</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">DB_NETIF</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Set sysctl options</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;&gt;</span><span class="token string bash punctuation" style="color:#393A34">/etc/sysctl.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_nonlocal_bind=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sysctl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install keepalived nc</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ yum </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-y</span><span class="token plain"> keepalived </span><span class="token function" style="color:#d73a49">nc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Add configuration</p>
<p>The following is the configuration for the primary node:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Make sure virtual_router_id doesn&#x27;t conflict with other keepalived clusters on the local network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34">/etc/keepalived/keepalived.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">global_defs {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    router_id onecloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">vrrp_script chk_mysql {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    script &quot;/etc/keepalived/chk_mysql&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    interval 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">vrrp_instance VI_1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    state MASTER</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    interface </span><span class="token string variable" style="color:#36acaa">$DB_NETIF</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    virtual_router_id 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    priority 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    advert_int 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    nopreempt</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    authentication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        auth_type PASS</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        auth_pass </span><span class="token string variable" style="color:#36acaa">$DBHA_KA_AUTH</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    track_script {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        chk_mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    virtual_ipaddress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        </span><span class="token string variable" style="color:#36acaa">$DB_VIP</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /etc/keepalived/chk_mysql</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">echo | nc 127.0.0.1 3306 &amp;&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /etc/keepalived/chk_mysql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The following is the configuration for the backup node:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Make sure the virtual_router_id of the backup node is the same as that of the primary node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34">/etc/keepalived/keepalived.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">global_defs {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    router_id onecloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">vrrp_script chk_mysql {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    script &quot;/etc/keepalived/chk_mysql&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    interval 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">vrrp_instance VI_1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    state BACKUP</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    interface </span><span class="token string variable" style="color:#36acaa">$DB_NETIF</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    virtual_router_id 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    priority 99</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    advert_int 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    nopreempt</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    authentication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        auth_type PASS</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        auth_pass </span><span class="token string variable" style="color:#36acaa">$DBHA_KA_AUTH</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    track_script {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        chk_mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    virtual_ipaddress {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        </span><span class="token string variable" style="color:#36acaa">$DB_VIP</span><span class="token string" style="color:#e3116c"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /etc/keepalived/chk_mysql</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">echo | nc 127.0.0.1 3306 &amp;&gt;/dev/null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /etc/keepalived/chk_mysql</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the configuration is complete, start <code>keepalived</code> on the master and standby nodes respectively using the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> addr show </span><span class="token variable" style="color:#36acaa">$DB_NETIF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">: eth0: </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">BROADCAST,MULTICAST,UP,LOWER_UP</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mtu </span><span class="token number" style="color:#36acaa">1500</span><span class="token plain"> qdisc pfifo_fast state UP group default qlen </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 00:22:cf:40:1e:29 brd ff:ff:ff:ff:ff:ff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.199.99/24 brd </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.199.255 scope global dynamic eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft 100651906sec preferred_lft 100651906sec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet </span><span class="token number" style="color:#36acaa">192.168</span><span class="token plain">.199.97/32 scope global eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet6 fe80::222:cfff:fe40:1e29/64 scope </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configure-keepalived-to-switch-network-adapter-automatically">Configure <code>keepalived</code> to switch network adapter automatically<a class="hash-link" aria-label="Direct link to configure-keepalived-to-switch-network-adapter-automatically" title="Direct link to configure-keepalived-to-switch-network-adapter-automatically" href="/en/docs/operations/databases/db-ha#configure-keepalived-to-switch-network-adapter-automatically">​</a></h3>
<p>In this solution, <code>k8s</code> and <code>mysql</code> share the same network adapter. If <code>k8s</code> uses the <code>host</code> feature, it will automatically enable the <code>br0</code> network adapter. When <code>host</code> starts or switches network adapters, it may affect the high availability of <code>mysql</code>. The following auxiliary script can enhance the stability of <code>k8s+mysql</code>.</p>
<p>Run the following scripts respectively on the primary and standby nodes of <code>db</code>. Be sure to replace the <code>node_ip</code> variable in the first line with the machine&#x27;s own IP address.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Replace the variable DB_NODE_IP in this script with the local IP address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">node_ip</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$DB_NODE_IP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-z</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$node_ip</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;please export variable &#x27;node_ip&#x27; first! &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF_CK1</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34">/etc/keepalived/check_interface.sh</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">datestr=&quot;\</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">date</span><span class="token string variable" style="color:#36acaa"> +</span><span class="token string variable string" style="color:#e3116c">&quot;%F %T&quot;</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">env_interface=\</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">cat</span><span class="token string variable" style="color:#36acaa"> /etc/keepalived/keepalived.conf</span><span class="token string variable operator" style="color:#393A34">|</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable function" style="color:#d73a49">grep</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable parameter variable" style="color:#36acaa">-w</span><span class="token string variable" style="color:#36acaa"> interface </span><span class="token string variable operator" style="color:#393A34">|</span><span class="token string variable function" style="color:#d73a49">awk</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable string" style="color:#e3116c">&#x27;{print \$2}&#x27;</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">echo &quot;[\</span><span class="token string variable" style="color:#36acaa">$datestr</span><span class="token string" style="color:#e3116c">] The interface keepalived is currently listening on: \</span><span class="token string variable" style="color:#36acaa">$env_interface</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">router_interface=\</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable" style="color:#36acaa">/usr/sbin/ip a show </span><span class="token string variable operator" style="color:#393A34">|</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable function" style="color:#d73a49">grep</span><span class="token string variable" style="color:#36acaa"> $node_ip </span><span class="token string variable operator" style="color:#393A34">|</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable function" style="color:#d73a49">awk</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable string" style="color:#e3116c">&#x27;{ print \$NF}&#x27;</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">echo &quot;[\</span><span class="token string variable" style="color:#36acaa">$datestr</span><span class="token string" style="color:#e3116c">] The name of the interface where the ip is located: [\</span><span class="token string variable" style="color:#36acaa">$router_interface</span><span class="token string" style="color:#e3116c">]&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">if [[ -n &quot;\</span><span class="token string variable" style="color:#36acaa">$router_interface</span><span class="token string" style="color:#e3116c">&quot; ]] &amp;&amp; [[ &quot;\</span><span class="token string variable" style="color:#36acaa">$router_interface</span><span class="token string" style="color:#e3116c">&quot; != &quot;\</span><span class="token string variable" style="color:#36acaa">$env_interface</span><span class="token string" style="color:#e3116c">&quot; ]]; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    echo &quot;[\</span><span class="token string variable" style="color:#36acaa">$datestr</span><span class="token string" style="color:#e3116c">] updating keepalived.conf interface&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    sed -i -e &quot;s#\</span><span class="token string variable" style="color:#36acaa">$env_interface</span><span class="token string" style="color:#e3116c">#\</span><span class="token string variable" style="color:#36acaa">$router_interface</span><span class="token string" style="color:#e3116c">#g&quot; /etc/keepalived/keepalived.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    systemctl restart keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    echo &quot;[\</span><span class="token string variable" style="color:#36acaa">$datestr</span><span class="token string" style="color:#e3116c">] No need to update interface. &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF_CK1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF_CK2</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34">/etc/keepalived/check_interface2.sh</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#!/usr/bin/env bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">for i in {1..3}; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    /etc/keepalived/check_interface.sh &gt;&gt; /var/log/keepalived.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    sleep 20</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">done</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF_CK2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF_CRON</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34">/etc/cron.d/update_keepalived_interface</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">* * * * * root /etc/keepalived/check_interface2.sh &gt;/dev/null 2&gt;&amp;1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF_CRON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart crond</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /etc/keepalived/chk_mysql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /etc/keepalived/check_interface.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /etc/keepalived/check_interface2.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--now</span><span class="token plain"> keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart keepalived</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /etc/rc.d/rc.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-q</span><span class="token plain"> /etc/keepalived/check_interface.sh /etc/rc.d/rc.local</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$a bash /etc/keepalived/check_interface.sh &gt;&gt; /var/log/keepalived.log&#x27;</span><span class="token plain"> /etc/rc.d/rc.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Thus, the high availability deployment of DB is completed. The Mariadb or keepalived service of any node can be down without affecting external services in case of a node failure.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/yunionio/website/tree/master/docs/operations/databases/db-ha.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/operations/databases/mysql_config"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">MariaDB Recommended Configurations</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/operations/databases/mysql_ha_recovery"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">MariaDB 双主同步恢复</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/en/docs/operations/databases/db-ha#deployment">Deployment</a><ul><li><a class="table-of-contents__link toc-highlight" href="/en/docs/operations/databases/db-ha#configure-mariadb-master-master-replication">Configure Mariadb master-master replication</a></li><li><a class="table-of-contents__link toc-highlight" href="/en/docs/operations/databases/db-ha#deploy-and-configure-keepalived">Deploy and configure keepalived</a></li><li><a class="table-of-contents__link toc-highlight" href="/en/docs/operations/databases/db-ha#configure-keepalived-to-switch-network-adapter-automatically">Configure <code>keepalived</code> to switch network adapter automatically</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>