"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[9174],{86893:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>u,frontMatter:()=>s,metadata:()=>d,toc:()=>c});var o=i(74848),r=i(28453);const s={title:"\u4f7f\u7528Linux vfio\u5c06Nvidia GPU\u900f\u4f20\u7ed9QEMU\u865a\u62df\u673a",date:new Date("2021-06-07T00:00:00.000Z"),slug:"nvidia-gpu-passthrough-record",authors:[{name:"Zexi Li",url:"https://github.com/zexi",image_url:"https://github.com/zexi.png"}]},a=void 0,d={permalink:"/en/blog/nvidia-gpu-passthrough-record",editUrl:"https://github.com/yunionio/website/tree/master/blog/2021-06-07-nvida-gpu-passthrough-record.md",source:"@site/blog/2021-06-07-nvida-gpu-passthrough-record.md",title:"\u4f7f\u7528Linux vfio\u5c06Nvidia GPU\u900f\u4f20\u7ed9QEMU\u865a\u62df\u673a",description:"Linux \u4e0a\u865a\u62df\u673a GPU \u900f\u4f20\u9700\u8981\u4f7f\u7528 vfio \u7684\u65b9\u5f0f\u3002\u4e3b\u8981\u662f\u56e0\u4e3a\u5728 vfio \u65b9\u5f0f\u4e0b\u5bf9\u865a\u62df\u8bbe\u5907\u7684\u6743\u9650\u548c DMA \u9694\u79bb\u4e0a\u505a\u7684\u66f4\u597d\u3002\u4f46\u662f\u8fd9\u4e48\u505a\u4e5f\u6709\u4e2a\u7f3a\u70b9\uff0c\u8fd9\u4e2a\u7269\u7406\u8bbe\u5907\u5728\u4e3b\u673a\u548c\u5176\u4ed6\u865a\u62df\u673a\u90fd\u4e0d\u80fd\u4f7f\u7528\u4e86\u3002",date:"2021-06-07T00:00:00.000Z",tags:[],readingTime:9.575,hasTruncateMarker:!0,authors:[{name:"Zexi Li",url:"https://github.com/zexi",image_url:"https://github.com/zexi.png",imageURL:"https://github.com/zexi.png"}],frontMatter:{title:"\u4f7f\u7528Linux vfio\u5c06Nvidia GPU\u900f\u4f20\u7ed9QEMU\u865a\u62df\u673a",date:"2021-06-07T00:00:00.000Z",slug:"nvidia-gpu-passthrough-record",authors:[{name:"Zexi Li",url:"https://github.com/zexi",image_url:"https://github.com/zexi.png",imageURL:"https://github.com/zexi.png"}]},unlisted:!1,prevItem:{title:"\u4f7f\u7528 Cgroups \u9650\u5236 Kubernetes Pod \u8fdb\u7a0b\u6570",permalink:"/en/blog/cgroups-kubernetes-pid-limits"},nextItem:{title:"Cloudpods 3.7\u7248\u672c\u65b0\u529f\u80fd\u4ecb\u7ecd",permalink:"/en/blog/cloudpods-3.7-new-feature-introduction"}},t={authorsImageUrls:[void 0]},c=[{value:"\u7cfb\u7edf\u53ca\u786c\u4ef6\u51c6\u5907",id:"\u7cfb\u7edf\u53ca\u786c\u4ef6\u51c6\u5907",level:2},{value:"BIOS\u4e2d\u6253\u5f00IOMMU",id:"bios\u4e2d\u6253\u5f00iommu",level:3},{value:"\u5185\u6838\u914d\u7f6e\u52fe\u9009IOMMU",id:"\u5185\u6838\u914d\u7f6e\u52fe\u9009iommu",level:3},{value:"\u5185\u6838\u542f\u52a8\u53c2\u6570enable IOMMU",id:"\u5185\u6838\u542f\u52a8\u53c2\u6570enable-iommu",level:3},{value:"\u627e\u5230 nvidia GPU BusID",id:"\u627e\u5230-nvidia-gpu-busid",level:3},{value:"\u4f7f\u7528 vfio \u7ba1\u7406 GPU",id:"\u4f7f\u7528-vfio-\u7ba1\u7406-gpu",level:3},{value:"\u4f7f\u7528 qemu \u900f\u4f20 nvidia GPU",id:"\u4f7f\u7528-qemu-\u900f\u4f20-nvidia-gpu",level:3},{value:"\u5b89\u88c5nvidia \u9a71\u52a8\u548c Cuda",id:"\u5b89\u88c5nvidia-\u9a71\u52a8\u548c-cuda",level:2},{value:"\u5b89\u88c5 nvidia \u9a71\u52a8",id:"\u5b89\u88c5-nvidia-\u9a71\u52a8",level:3},{value:"\u5b89\u88c5 cuda",id:"\u5b89\u88c5-cuda",level:3}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"Linux \u4e0a\u865a\u62df\u673a GPU \u900f\u4f20\u9700\u8981\u4f7f\u7528 vfio \u7684\u65b9\u5f0f\u3002\u4e3b\u8981\u662f\u56e0\u4e3a\u5728 vfio \u65b9\u5f0f\u4e0b\u5bf9\u865a\u62df\u8bbe\u5907\u7684\u6743\u9650\u548c DMA \u9694\u79bb\u4e0a\u505a\u7684\u66f4\u597d\u3002\u4f46\u662f\u8fd9\u4e48\u505a\u4e5f\u6709\u4e2a\u7f3a\u70b9\uff0c\u8fd9\u4e2a\u7269\u7406\u8bbe\u5907\u5728\u4e3b\u673a\u548c\u5176\u4ed6\u865a\u62df\u673a\u90fd\u4e0d\u80fd\u4f7f\u7528\u4e86\u3002"}),"\n",(0,o.jsx)(n.p,{children:"qemu \u76f4\u63a5\u4f7f\u7528\u7269\u7406\u8bbe\u5907\u672c\u8eab\u547d\u4ee4\u884c\u662f\u5f88\u7b80\u5355\u7684\uff0c\u5173\u952e\u5728\u4e8e\u4e8b\u5148\u5728\u4e3b\u673a\u4e0a\u5bf9\u7cfb\u7edf\u3001\u5185\u6838\u548c\u7269\u7406\u8bbe\u5907\u7684\u4e00\u4e9b\u914d\u7f6e\u3002"}),"\n",(0,o.jsxs)(n.p,{children:["\u5355\u7eaf\u4ece qemu \u7684\u547d\u4ee4\u884c\u6765\u770b\uff0c\u5176\u5b9e\u548c\u666e\u901a\u865a\u62df\u673a\u542f\u52a8\u5c31\u5dee\u4e86\u6700\u540e\u90a3\u4e2a ",(0,o.jsx)(n.code,{children:"-device"})," \u7684\u9009\u9879\u3002\u8fd9\u4e2a\u9009\u9879\u4e5f\u6bd4\u8f83\u5bb9\u6613\u7406\u89e3\uff0c\u5c31\u662f\u628a\u4e3b\u673a\u4e0a\u7684\u8bbe\u5907 0000:00:01.0 \u4f20\u7ed9\u4e86\u865a\u62df\u673a\u4f7f\u7528\u3002"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ qemu-system-x86_64 -m 4096 -smp 4 --enable-kvm \\\n  -drive file=~/guest/fedora.img \\\n  -device vfio-pci,host=0000:00:01.0\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u7cfb\u7edf\u53ca\u786c\u4ef6\u51c6\u5907",children:"\u7cfb\u7edf\u53ca\u786c\u4ef6\u51c6\u5907"}),"\n",(0,o.jsx)(n.h3,{id:"bios\u4e2d\u6253\u5f00iommu",children:"BIOS\u4e2d\u6253\u5f00IOMMU"}),"\n",(0,o.jsx)(n.p,{children:"\u8bbe\u5907\u76f4\u901a\u5728 x86 \u5e73\u53f0\u4e0a\u9700\u8981\u6253\u5f00 iommu \u529f\u80fd\u3002\u8fd9\u662f Intel \u865a\u62df\u6280\u672f VT-d(Virtualization Technology for Device IO) \u4e2d\u7684\u4e00\u4e2a\u90e8\u5206\u3002\u6709\u65f6\u5019\u8fd9\u90e8\u5206\u7684\u529f\u80fd\u6ca1\u6709\u88ab\u6253\u5f00\u3002"}),"\n",(0,o.jsx)(n.p,{children:"\u6253\u5f00\u7684\u65b9\u5f0f\u5728 BIOS \u8bbe\u7f6e\u4e2d Security->Virtualization->VT-d \u8fd9\u4e2a\u4f4d\u7f6e\u3002\u5f53\u7136\u4e0d\u540c\u7684 BIOS \u4f4d\u7f6e\u53ef\u80fd\u4f1a\u7565\u6709\u4e0d\u540c\u3002\u8bb0\u5f97\u5728\u4f7f\u7528\u76f4\u901a\u8bbe\u5907\u524d\u8981\u5c06\u8fd9\u4e2a\u9009\u9879\u6253\u5f00\u3002"}),"\n",(0,o.jsx)(n.h3,{id:"\u5185\u6838\u914d\u7f6e\u52fe\u9009iommu",children:"\u5185\u6838\u914d\u7f6e\u52fe\u9009IOMMU"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"INTEL_IOMMU\n\u2502 Location: \u2502\n\u2502 -> Device Drivers \u2502\n\u2502 (2) -> IOMMU Hardware Support (IOMMU_SUPPORT [=y])\n"})}),"\n",(0,o.jsx)(n.h3,{id:"\u5185\u6838\u542f\u52a8\u53c2\u6570enable-iommu",children:"\u5185\u6838\u542f\u52a8\u53c2\u6570enable IOMMU"}),"\n",(0,o.jsx)(n.p,{children:"BIOS \u4e2d\u6253\u5f00\uff0c\u5185\u6838\u7f16\u8bd1\u9009\u9879\u52fe\u9009\u8fd8\u4e0d\u591f\u3002\u8fd8\u9700\u8981\u5728\u5f15\u5bfc\u7a0b\u5e8f\u4e2d\u6dfb\u52a0\u4e0a\u5185\u6838\u542f\u52a8\u53c2\u6570"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'# \u5bf9\u5e94\u7f16\u8f91 /etc/default/grub, \u8bbe\u7f6e GRUB_CMDLINE_LINUX=\n$ cat /etc/default/grub\n...\nGRUB_CMDLINE_LINUX="intel_iommu=on iommu=pt vfio_iommu_type1.allow_unsafe_interrupts=1 rdblacklist=nouveau nouveau.modeset=0"\n...\n \n# \u91cd\u65b0\u751f\u6210 grub \u5f15\u5bfc\u914d\u7f6e\u6587\u4ef6\n$ grub2-mkconfig -o /boot/grub2/grub.cfg\n \n# \u5c06vfio\u76f8\u5173 module \u8bbe\u7f6e\u4e3a\u5f00\u673aload\n$ cat /etc/modules-load.d/vfio.conf\nvfio\nvfio_iommu_type1\nvfio_pci\nvfio_virqfd\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF#Setting_up_IOMMU",children:"Setting up IOMMU"}),"\n",(0,o.jsx)(n.a,{href:"https://wiki.archlinux.org/index.php/Kernel_parameters",children:"Kernel parameters"})]}),"\n",(0,o.jsx)(n.h3,{id:"\u627e\u5230-nvidia-gpu-busid",children:"\u627e\u5230 nvidia GPU BusID"}),"\n",(0,o.jsx)(n.p,{children:"record PCI addresses and hardware IDs of the GPU"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'$ lspci -k | grep -i nvidia -A 3                   \n41:00.0 VGA compatible controller: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti] (rev a1)\n        Subsystem: Device 1b4c:11bf\n        Kernel driver in use: vfio-pci\n        Kernel modules: nouveau\n41:00.1 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller (rev a1)\n        Subsystem: Device 1b4c:11bf\n        Kernel driver in use: snd_hda_intel\n        Kernel modules: snd_hda_intel\n# pci address => 41:00.0,41:00.1\n# device id => 1b4c:11bf\n \n# \u8fd9\u91cc\u627e\u5230\u4e86\u4e24\u5f20 nvidia \u5361\uff0c\u5b83\u4eec\u7684 device id \u90fd\u662f 1b4c:11bf, \u4e00\u5f20\u662f Audio device\n# \u8fd9\u6837\u662f\u4e0d\u80fd passthrough \u8fdb\u53bb\u7684\uff0c\u56e0\u4e3a:\n# vfio-pci use your vendor and device id pair to identify which device they need to bind to at boot,\n# if you have two GPUs sharing such an ID pair you will not be able to get your passthough driver to bind with just one of them\n# \u4f7f\u7528\u4e0b\u9762\u7684\u811a\u672c\u89e3\u51b3\u8fd9\u79cd\u60c5\u51b5\uff1a\n \n$ cat /usr/bin/vfio-pci-override.sh\n#!/bin/sh\n \nfor i in $(find /sys/devices/pci* -name boot_vga); do\n    if [ $(cat "$i") -eq 0 ]; then\n        GPU="${i%/boot_vga}"\n        AUDIO="$(echo "$GPU" | sed -e "s/0$/1/")"\n        echo "vfio-pci" > "$GPU/driver_override"\n        if [ -d "$AUDIO" ]; then\n            echo "vfio-pci" > "$AUDIO/driver_override"\n        fi\n    fi\ndone\n \nmodprobe -i vfio-pci\n \n# \u628a\u811a\u672c\u4f20\u5165 /etc/modprobe.d/vfio.conf\n$ cat /etc/modprobe.d/vfio.conf\ninstall vfio-pci /usr/bin/vfio-pci-override.sh\noptions vfio-pci ids=10de:1c82 disable_vga=1\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\u4f7f\u7528-vfio-\u7ba1\u7406-gpu",children:"\u4f7f\u7528 vfio \u7ba1\u7406 GPU"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# /etc/modprobe.d/vfio.conf, ids \u4e3a lspci \u627e\u5230\u7684 hardware id, \u591a\u4e2a\u8bbe\u5907\u7684\u8bdd\u7528','\u5206\u5272\n$ cat /etc/modprobe.d/vfio.conf\noptions vfio-pci ids=10de:134d disable_vga=1\n \n# \u7981\u7528NVIDIA nouveau \u5f00\u6e90\u9a71\u52a8, /etc/modprobe.d/blacklist.conf\n$ cat /etc/modprobe.d/blacklist.conf\nblacklist nouveau\n \n# kvm \u6a21\u5757\u914d\u7f6e, /etc/modprobe.d/kvm.conf\n$ cat /etc/modprobe.d/kvm.conf\noptions kvm ignore_msrs=1\n"})}),"\n",(0,o.jsx)(n.p,{children:"\u91cd\u542f\u7cfb\u7edf\uff0c\u542f\u52a8\u5b8c\u6210\u540e\u67e5\u770b\u5f53\u524d\u7684 nvidia GPU \u662f\u5426\u88ab vfio-pci \u6a21\u5757\u4f7f\u7528, \u786e\u8ba4IOMMU\u529f\u80fd\u786e\u5b9e\u6253\u5f00\u3002"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ dmesg | grep -e DMAR -e IOMMU | grep enabled\n \n# \u5982\u679c\u80fd\u641c\u7d22\u5230\nDMAR: IOMMU enabled\n# \u8868\u793a\u4e0a\u8ff0\u914d\u7f6e\u6210\u529f\u3002\n \n# \u67e5\u770b GPU \u662f\u5426\u88ab vfio-pci \u4f7f\u7528\n# \u53e6\u5916\u6ce8\u610f\u68c0\u67e5\u770b\u770b 41:00.1 Audio device \u662f\u5426\u4e5f\u88ab vfio-pci \u4f7f\u7528\n$ lspci -k | grep -i -e nvidia -A 3\n41:00.0 VGA compatible controller: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti] (rev a1)\n    Subsystem: Device 1b4c:11bf\n    Kernel driver in use: vfio-pci # GTX 1050 Ti GPU \u88ab vfio-pci \u4f7f\u7528\n    Kernel modules: nouveau\n41:00.1 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller (rev a1)\n    Subsystem: Device 1b4c:11bf\n    Kernel driver in use: vfio-pci # \u53d1\u73b0 Audio device \u4e5f\u88ab vfio-pci \u4f7f\u7528\u4e86\n    Kernel modules: snd_hda_intel\n...\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'# list GPU IOMMU group\n$ find /sys/kernel/iommu_groups/ -type l | grep 41:00\n/sys/kernel/iommu_groups/27/devices/0000:41:00.0\n/sys/kernel/iommu_groups/27/devices/0000:41:00.1\n \n# \u627e\u5230IOMMU Group \u7ba1\u7406\u7684 PCI \u8bbe\u5907\n#!/bin/bash\nshopt -s nullglob\nfor d in /sys/kernel/iommu_groups/*/devices/*; do\n  n=${d#*/iommu_groups/*}; n=${n%%/*}\n  printf \'IOMMU Group %s \' "$n"\n  lspci -nns "${d##*/}"\ndone\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\u4f7f\u7528-qemu-\u900f\u4f20-nvidia-gpu",children:"\u4f7f\u7528 qemu \u900f\u4f20 nvidia GPU"}),"\n",(0,o.jsx)(n.p,{children:"\u51c6\u5907\u597dcentos7\u955c\u50cf\uff0c\u7136\u540e\u5728\u865a\u62df\u673a\u91cc\u9762\u5b89\u88c5 nvidia \u5b98\u65b9\u95ed\u6e90\u9a71\u52a8\u548c cuda SDK"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# \u6211\u4ece\u670d\u52a1\u5668\u4e0a\u62f7\u8d1d\u8fc7\u6765\u7684\u662f vmdk \u7684\u955c\u50cf\uff0c\u5148\u628a\u5b83\u8f6c\u6362\u6210 qcow2 \u7684\u683c\u5f0f\n$ /usr/local/qemu-2.9.0/bin/qemu-img convert -f vmdk -O qcow2 centos-7.3.1611-20180104.vmdk centos-7.3.1611-20180104.qcow2\n \n# \u4f7f\u7528 qemu \u542f\u52a8\uff0c\u6ce8\u610f-cpu \u9700\u8981 kvm=off \u53c2\u6570\n# kvm=off will hide the kvm hypervisor signature, this is required for NVIDIA cards\n# since its driver will refuse to work on an hypervisor and result in Code 43 on windows\n$ cat startvm.sh\n#!/bin/sh\n/usr/local/qemu-2.9.0/bin/qemu-system-x86_64 -enable-kvm \\\n-m 4096 -cpu host,kvm=off -smp 4,sockets=1,cores=4,threads=1 \\\n-drive file=./centos-7.3.1611-20180104.qcow2 \\\n-device vfio-pci,host=41:00.0,multifunction=on,addr=0x16 \\\n-device vfio-pci,host=41:00.1 \\\n-net nic,model=e1000 -net user,hostfwd=tcp::5022-:22 \\\n-vnc :1\n \n# \u8fd9\u53f0\u865a\u62df\u673a\u5f00\u4e86vnc\u548cssh \u7aef\u53e3\u8f6c\u53d1\uff0c\u53ef\u4ee5\u4f7f\u7528vnc\u6216\u8005ssh\u8bbf\u95ee\n \n# \u4ecehost\u8fdb\u5165\u865a\u62df\u673a\n$ ssh 127.0.0.1 -p 5022\n \n# \u67e5\u770b\u865a\u62df\u673a\u900f\u4f20\u8fdb\u6765\u7684\u663e\u5361\n$ lspci -k | grep -i nvidia -A 3\n00:04.0 Audio device: NVIDIA Corporation Device 0fb9 (rev a1)\n    Subsystem: Device 1b4c:11bf\n    Kernel driver in use: snd_hda_intel\n    Kernel modules: snd_hda_intel\n00:16.0 VGA compatible controller: NVIDIA Corporation GP107 (rev a1)\n    Subsystem: Device 1b4c:11bf\n    Kernel modules: nouveau\n"})}),"\n",(0,o.jsx)(n.h2,{id:"\u5b89\u88c5nvidia-\u9a71\u52a8\u548c-cuda",children:"\u5b89\u88c5nvidia \u9a71\u52a8\u548c Cuda"}),"\n",(0,o.jsx)(n.p,{children:"nvidia \u9a71\u52a8\u9700\u8981\u4ece\u5b98\u65b9\u4e0b\u8f7d\uff0c\u5982\u679c\u5148\u5b89\u88c5 cuda \u7684\u8bdd\u4f1a\u4e00\u540c\u5b89\u88c5 nvidia \u9a71\u52a8\u3002\n\u63a5\u4e0b\u6765\u91c7\u7528\u865a\u62df\u673a\u5148\u5b89\u88c5\u9a71\u52a8\u518d\u5b89\u88c5 cuda \u7684\u6b65\u9aa4\u3002"}),"\n",(0,o.jsxs)(n.p,{children:["\u53c2\u8003\uff1a\n",(0,o.jsx)(n.a,{href:"http://www.advancedclustering.com/act_kb/installing-nvidia-drivers-rhel-centos-7/",children:"installing-nvidia-drivers-centos-7"}),"\n",(0,o.jsx)(n.a,{href:"https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html",children:"NVIDIA CUDA GETTINGS STARTED GUIDE FOR LINUX"})]}),"\n",(0,o.jsx)(n.h3,{id:"\u5b89\u88c5-nvidia-\u9a71\u52a8",children:"\u5b89\u88c5 nvidia \u9a71\u52a8"}),"\n",(0,o.jsxs)(n.p,{children:["\u4e0b\u8f7d\u5730\u5740\uff1a",(0,o.jsx)(n.a,{href:"http://www.nvidia.com/object/unix.html",children:"http://www.nvidia.com/object/unix.html"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'# update \u540e\u5982\u679c\u66f4\u65b0\u5185\u6838\uff0c\u9700\u8981\u91cd\u542f\n$ yum -y update\n \n# \u5b89\u88c5 gcc\u3001make\u3001glibc\u7b49\u5de5\u5177\u548c\u5e93\n$ yum -y groupinstall "Development Tools"\n$ yum -y install kernel-devel\n \n# Download the latest NVIDIA driver for unix.\n$ wget http://us.download.nvidia.com/XFree86/Linux-x86_64/390.42/NVIDIA-Linux-x86_64-390.42.run\n$ yum -y install epel-release\n$ yum -y install dkms\n \n# Edit /etc/default/grub. Append the following  to \u201cGRUB_CMDLINE_LINUX\u201d\nrd.driver.blacklist=nouveau nouveau.modeset=0\n \n# Generate a new grub configuration to include the above changes.\n$ grub2-mkconfig -o /boot/grub2/grub.cfg\n \n# Edit/create /etc/modprobe.d/blacklist.conf and append:\nblacklist nouveau\n \n# Backup your old initramfs and then build a new one\n$ mv /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r)-nouveau.img\n$ dracut /boot/initramfs-$(uname -r).img $(uname -r)\n \n# \u91cd\u542fagain\n \n# Run the NVIDIA driver installer and enter yes to all options.\n$ sh NVIDIA-Linux-x86_64-*.run\n \n# \u88c5\u597d\u540e\u518d\u4e00\u6b21\u91cd\u542f\uff0clspci -k \u770b\u4e0bgpu\u4f7f\u7528\u7684\u9a71\u52a8\u662f\u5426\u662fnvidia\n$ lspci -k | grep -i nvidia -A 3\n00:04.0 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller (rev a1)\n00:16.0 VGA compatible controller: NVIDIA Corporation GP107 [GeForce GTX 1050 Ti] (rev a1)\n    Kernel driver in use: nvidia # \u53d1\u73b0\u5df2\u7ecf\u4f7f\u7528nvidia\u9a71\u52a8\n    Kernel modules: nouveau, nvidia_drm, nvidia\n \n# \u6267\u884c nvidia-smi \u770b\u4e0b\u8f93\u51fa\u548c\u6e29\u5ea6\n$ nvidia-smi\nThu Mar 15 01:31:09 2018      \n+-----------------------------------------------------------------------------+\n| NVIDIA-SMI 390.42                 Driver Version: 390.42                    |\n|-------------------------------+----------------------+----------------------+\n| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |\n| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |\n|===============================+======================+======================|\n|   0  GeForce GTX 105...  Off  | 00000000:00:16.0 Off |                  N/A |\n| 40%   32C    P0    N/A / 100W |      0MiB /  4040MiB |      0%      Default |\n+-------------------------------+----------------------+----------------------+\n \n+-----------------------------------------------------------------------------+\n| Processes:                                                       GPU Memory |\n|  GPU       PID   Type   Process name                             Usage      |\n|=============================================================================|\n|  No running processes found                                                 |\n+-----------------------------------------------------------------------------+\n \n$ nvidia-smi -q -d TEMPERATURE\n \n==============NVSMI LOG==============\n \nTimestamp                           : Thu Mar 15 01:32:42 2018\nDriver Version                      : 390.42\n \nAttached GPUs                       : 1\nGPU 00000000:00:16.0\n    Temperature\n        GPU Current Temp            : 32 C\n        GPU Shutdown Temp           : 102 C\n        GPU Slowdown Temp           : 99 C\n        GPU Max Operating Temp      : N/A\n        Memory Current Temp         : N/A\n        Memory Max Operating Temp   : N/A\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\u5b89\u88c5-cuda",children:"\u5b89\u88c5 cuda"}),"\n",(0,o.jsxs)(n.p,{children:["\u4e0b\u8f7d\u5730\u5740\uff1a ",(0,o.jsx)(n.a,{href:"https://developer.nvidia.com/cuda-downloads",children:"https://developer.nvidia.com/cuda-downloads"}),"\n\u8fd9\u91cc\u9009\u62e9 runfile\uff0c\u4ee5\u540e\u4e3a\u4e86\u65b9\u4fbf\u4e5f\u53ef\u4ee5\u9009\u62e9 rpm(network)\u7684\u65b9\u5f0f\uff0c\u4f1a\u81ea\u52a8\u5e2e\u6211\u4eec\u5b89\u88c5 nvidia \u9a71\u52a8"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'$ wget https://developer.nvidia.com/compute/cuda/9.1/Prod/local_installers/cuda_9.1.85_387.26_linux\n \n# Say no to installing the NVIDIA driver.\n# The standalone driver you already installed is typically newer than what is packaged with CUDA.\n# Use the default option for all other choices.\n$ sh cuda_*.run\n \n# \u6dfb\u52a0 CUDA \u76f8\u5173\u7684\u73af\u5883\u53d8\u91cf\nexport PATH=$PATH:/usr/local/cuda/bin\nexport LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH\n \n# make samples\n$ cd ~/NVIDIA_CUDA-9.1_Samples; make -j 4\n$ cd bin/x86_64/linux/release\n$ ./deviceQuery # \u67e5\u8be2gpu\u4fe1\u606f\n./deviceQuery Starting...\n \n CUDA Device Query (Runtime API) version (CUDART static linking)\n \nDetected 1 CUDA Capable device(s)\n \nDevice 0: "GeForce GTX 1050 Ti"\n  CUDA Driver Version / Runtime Version          9.1 / 9.1\n  CUDA Capability Major/Minor version number:    6.1\n  Total amount of global memory:                 4040 MBytes (4236312576 bytes)\n  ( 6) Multiprocessors, (128) CUDA Cores/MP:     768 CUDA Cores\n  GPU Max Clock rate:                            1481 MHz (1.48 GHz)\n  Memory Clock rate:                             3504 Mhz\n  Memory Bus Width:                              128-bit\n  L2 Cache Size:                                 1048576 bytes\n...\n \n$ ./bandwidtTest # \u4f7f\u7528 cuda \u6d4b\u8bd5gpu bandwidth\nRunning on...\n \n Device 0: GeForce GTX 1050 Ti\n Quick Mode\n \n Host to Device Bandwidth, 1 Device(s)\n PINNED Memory Transfers\n   Transfer Size (Bytes)    Bandwidth(MB/s)\n   33554432            9719.0\n \n Device to Host Bandwidth, 1 Device(s)\n PINNED Memory Transfers\n   Transfer Size (Bytes)    Bandwidth(MB/s)\n   33554432            9215.8\n \n Device to Device Bandwidth, 1 Device(s)\n PINNED Memory Transfers\n   Transfer Size (Bytes)    Bandwidth(MB/s)\n   33554432            95525.1\n \nResult = PASS\n \nNOTE: The CUDA Samples are not meant for performance measurements. Results may vary when GPU Boost is enabled.\n'})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>d});var o=i(96540);const r={},s=o.createContext(r);function a(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);